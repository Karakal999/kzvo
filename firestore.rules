rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is super admin (головний адміністратор)
    function isSuperAdmin() {
      return isAuthenticated() && 
             request.auth.token.email == 'admin@kzvo.edu' &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if user is teacher
    function isTeacher() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }
    
    // Helper function to check if user is student
    function isStudent() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student';
    }
    
    // Helper function to check if user is teacher or admin
    function canManageContent() {
      return isAdmin() || isTeacher();
    }
    
    // Helper function to check if user is accessing their own data
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone can read their own user document
      // Admins can read all user documents
      allow read: if isOwner(userId) || isAdmin();
      
      // Users can update their own profile (except role)
      // Super admin can update any profile including roles
      // Regular admins can update any profile except role
      allow update: if (isOwner(userId) && 
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role'])) ||
                       isSuperAdmin() ||
                       (isAdmin() && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']));
      
      // Only authenticated users can create their profile during registration
      // The role must be 'student' for new registrations
      // Super admin can create users with any role
      allow create: if (isAuthenticated() && 
                       request.auth.uid == userId &&
                       request.resource.data.role == 'student') ||
                       isSuperAdmin();
      
      // Only admins can delete users (but not super admin account)
      allow delete: if isAdmin() && userId != request.auth.uid;
    }
    
    // News collection
    match /news/{newsId} {
      // Everyone can read news
      allow read: if true;
      
      // Admins and teachers can create news
      allow create: if canManageContent();
      
      // Users can update their own news, admins can update any
      allow update: if canManageContent() && 
                      (resource.data.authorId == request.auth.uid || isAdmin());
      
      // Only admins can delete news
      allow delete: if isAdmin();
    }
    
    // Events collection
    match /events/{eventId} {
      // Everyone can read events
      allow read: if true;
      
      // Only admins can create, update, or delete events
      allow create, update, delete: if isAdmin();
    }
    
    // Programs collection
    match /programs/{programId} {
      // Everyone can read programs
      allow read: if true;
      
      // Only admins can create, update, or delete programs
      allow create, update, delete: if isAdmin();
    }
    
    // Competitions collection
    match /competitions/{competitionId} {
      // Everyone can read competitions
      allow read: if true;
      
      // Only admins can create, update, or delete competitions
      allow create, update, delete: if isAdmin();
    }
    
    // Teachers collection
    match /teachers/{teacherId} {
      // Everyone can read teachers
      allow read: if true;
      
      // Only admins can create, update, or delete teachers
      allow create, update, delete: if isAdmin();
    }
    
    // Documents collection
    match /documents/{documentId} {
      // Everyone can read documents
      allow read: if true;
      
      // Admins and teachers can create, update, delete documents
      allow create, update, delete: if canManageContent();
    }
    
    // Announcements collection
    match /announcements/{announcementId} {
      // Everyone can read announcements
      allow read: if true;
      
      // Only admins can create, update, or delete announcements
      allow create, update, delete: if isAdmin();
    }
    
    // Settings collection (site-wide settings)
    match /settings/{settingId} {
      // Everyone can read settings
      allow read: if true;
      
      // Only super admin can update critical settings
      // Regular admins can update non-critical settings
      allow create, update, delete: if isSuperAdmin() || 
                                      (isAdmin() && settingId != 'critical');
    }
    
    // User submissions (for competitions, registrations, etc.)
    match /submissions/{submissionId} {
      // Users can read their own submissions
      // Teachers and admins can read all submissions
      allow read: if isAuthenticated() && 
                    (resource.data.userId == request.auth.uid || canManageContent());
      
      // Students and authenticated users can create submissions
      allow create: if isAuthenticated() && 
                      request.resource.data.userId == request.auth.uid;
      
      // Users can update their own submissions (if not locked)
      // Admins can update any submission
      allow update: if (isAuthenticated() && 
                       resource.data.userId == request.auth.uid &&
                       resource.data.locked != true) ||
                       isAdmin();
      
      // Only admins can delete submissions
      allow delete: if isAdmin();
    }
    
    // Default rule: deny all access to any other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

